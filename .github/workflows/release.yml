name: Release

on:
  release:
    types: [published]

env:
  CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

jobs:
  publish:
    name: Publish to Crates.io
    runs-on: ubuntu-latest
    # Order strictly follows the dependency graph (leaves first)
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      # Layer 0: Fully standalone (no internal VEX deps)
      - name: Publish vex-macros
        run: cargo publish -p vex-macros || echo "Already published or error, continuing..."
      - run: sleep 30

      - name: Publish vex-algoswitch
        run: cargo publish -p vex-algoswitch || echo "Already published or error, continuing..."
      - run: sleep 30

      - name: Publish vex-queue
        run: cargo publish -p vex-queue || echo "Already published or error, continuing..."
      - run: sleep 30

      # Layer 1: Depends only on Layer 0
      # vex-core optionally depends on vex-algoswitch (already published above)
      - name: Publish vex-core
        run: cargo publish -p vex-core || echo "Already published or error, continuing..."
      - run: sleep 30

      # Layer 2: Depends on vex-core
      - name: Publish vex-llm
        run: cargo publish -p vex-llm || echo "Already published or error, continuing..."
      - run: sleep 30

      - name: Publish vex-anchor
        run: cargo publish -p vex-anchor || echo "Already published or error, continuing..."
      - run: sleep 30

      # Layer 3: Depends on vex-core + vex-queue (both published)
      - name: Publish vex-persist
        run: cargo publish -p vex-persist || echo "Already published or error, continuing..."
      - run: sleep 30

      # Layer 4: Depends on vex-core + vex-llm + vex-persist
      - name: Publish vex-temporal
        run: cargo publish -p vex-temporal || echo "Already published or error, continuing..."
      - run: sleep 30

      - name: Publish vex-adversarial
        run: cargo publish -p vex-adversarial || echo "Already published or error, continuing..."
      - run: sleep 30

      # Layer 5: Depends on vex-llm
      - name: Publish vex-router
        run: cargo publish -p vex-router || echo "Already published or error, continuing..."
      - run: sleep 30

      # Layer 6: Depends on vex-adversarial + vex-anchor + vex-persist + vex-llm
      - name: Publish vex-runtime
        run: cargo publish -p vex-runtime || echo "Already published or error, continuing..."
      - run: sleep 30

      # Layer 7: Top Level Gateway (depends on almost everything above)
      - name: Publish vex-api
        run: cargo publish -p vex-api || echo "Already published or error, continuing..."
      - run: sleep 30

      # Layer 8: CLI (Renamed to avoid conflict)
      - name: Publish vex-protocol-cli
        run: cargo publish -p vex-protocol-cli || echo "Already published or error, continuing..."
